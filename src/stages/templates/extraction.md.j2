{#
  EXTRACTION STAGE TEMPLATE

  Composed with engine-specific context to create full extraction prompts.

  Variables available:
  - engine_key: str
  - audience: str
  - extraction: dict (from ExtractionContext)
  - framework_primer: str (loaded from framework file)
  - has_framework: bool
  - vocabulary: dict (audience-specific terms)
  - audience_guidance: str
  - schema: dict (canonical_schema)
  - schema_json: str (formatted schema)
#}

# {{ extraction.analysis_type | title }} Extraction

You are performing **{{ extraction.analysis_type }}** analysis.

**Core Question**: {{ extraction.core_question }}

---

{% if has_framework %}
## METHODOLOGICAL FRAMEWORK

{{ framework_primer }}

---
{% endif %}

{{ audience_guidance }}

---

## YOUR EXTRACTION TASK

Analyze the document(s) to extract {{ extraction.analysis_type_plural }}.

{% if extraction.extraction_steps %}
### EXTRACTION STEPS

{% for step in extraction.extraction_steps %}
{{ loop.index }}. {{ step }}
{% endfor %}
{% endif %}

{% if extraction.key_relationships %}
### RELATIONSHIPS TO IDENTIFY

For each {{ extraction.analysis_type }}, identify connections:
{% for rel in extraction.key_relationships %}
- **{{ rel }}**: Map where {{ extraction.analysis_type_plural }} {{ rel | replace('_', ' ') }} each other
{% endfor %}
{% endif %}

{% if extraction.key_fields %}
### KEY OUTPUT FIELDS

{% for field, description in extraction.key_fields.items() %}
- **{{ field }}**: {{ description }}
{% endfor %}
{% endif %}

{% if extraction.special_instructions %}
### ADDITIONAL INSTRUCTIONS

{{ extraction.special_instructions }}
{% endif %}

---

## ID NAMING CONVENTION

Use the format `{{ extraction.id_field }}` for all identifiers.
- Pattern: `{{ extraction.id_field.replace('_id', '').upper() }}{N}` (e.g., {{ extraction.id_field.replace('_id', '').upper() }}1, {{ extraction.id_field.replace('_id', '').upper() }}2, ...)

---

{% if schema_json %}
{{ schema_json }}
{% endif %}

---

## BUILD THE RELATIONSHIP GRAPH (CRITICAL FOR VISUALIZATION)

You MUST populate the `relationship_graph` structure with nodes, edges, and clusters. This enables visual analysis and pattern detection.

### CREATE NODES

For **every entity** you extract, create a corresponding node in `relationship_graph.nodes`:

```json
{
  "id": "the entity's ID (e.g., {{ extraction.id_field.replace('_id', '').upper() }}1)",
  "type": "the entity type",
  "label": "short evocative name (2-5 words)",
  "weight": 0.0-1.0 (centrality/importance in the analysis)
}
```

{% if extraction.key_fields %}
Entity types to create nodes for:
{% for field, description in extraction.key_fields.items() %}
- **{{ field | replace('_id', '') }}** ({{ field }}): {{ description }}
{% endfor %}
{% endif %}

Weight guidance:
- **1.0**: Central/foundational entities that organize the entire analysis
- **0.7-0.9**: Important entities with many connections
- **0.4-0.6**: Supporting entities with moderate significance
- **0.1-0.3**: Peripheral entities with limited connections

### CREATE EDGES

For **every cross-reference** between entities, create an edge in `relationship_graph.edges`:

```json
{
  "from_id": "source entity ID",
  "to_id": "target entity ID",
  "relationship": "relationship type",
  "strength": 0.0-1.0,
  "bidirectional": true/false,
  "label": "optional edge annotation"
}
```

{% if extraction.key_relationships %}
Relationship types to use:
{% for rel in extraction.key_relationships %}
- **{{ rel }}**: strength 0.7-1.0 for strong structural relations, 0.4-0.6 for contingent associations
{% endfor %}
{% endif %}

Strength guidance:
- **1.0**: Necessary/definitional relationship (one entity requires the other)
- **0.7-0.9**: Strong structural relationship
- **0.4-0.6**: Contingent/associative relationship
- **0.1-0.3**: Weak or speculative connection

### IDENTIFY CLUSTERS

Group tightly related entities into thematic clusters in `relationship_graph.clusters`:

```json
{
  "cluster_id": "CL1",
  "name": "evocative cluster name",
  "member_ids": ["entity IDs in this cluster"],
  "coherence": 0.0-1.0,
  "theme": "what unifies this cluster"
}
```

Name clusters based on what they reveal about the underlying {{ extraction.analysis_type }} structure.

---

## OUTPUT REQUIREMENTS

1. **Be comprehensive** - capture all significant {{ extraction.analysis_type_plural }}
2. **Be precise** - each extraction should be clearly defined
3. **Build the graph** - every entity becomes a node, every cross-reference becomes an edge
4. **Match audience** - calibrate language to {{ audience }} level

Extract with full analytical sophistication. Your output will be used for synthesis and visualization.
