#!/usr/bin/env python3
"""Create Phase 9 vulnerability analysis engines for Analyzer V2."""

import json
from pathlib import Path

ENGINES_DIR = Path(__file__).parent.parent / "src" / "engines" / "definitions"

VULNERABILITY_ENGINES = [
    {
        "engine_key": "concept_vulnerability_unstated_premises",
        "engine_name": "Concept Vulnerability: Unstated Premises",
        "description": "Finds arguments that rely on hidden assumptions that could be challenged",
        "category": "concept_analysis",
        "kind": "diagnostic",
        "reasoning_domain": "logical vulnerabilities",
        "researcher_question": "What hidden assumptions make this argument work?",
        "extraction_prompt": """You are conducting UNSTATED PREMISES vulnerability analysis.

## YOUR TASK

Find arguments about "{concept}" that rely on HIDDEN ASSUMPTIONS.

## WHAT TO LOOK FOR

An unstated premise is an assumption that:
- Is REQUIRED for the argument to work
- Is NOT explicitly stated
- COULD BE CHALLENGED

Examples:
- Assuming capitalism is the only alternative
- Assuming human nature is fixed
- Assuming efficiency metrics are valid

## ARGUMENTS TO ANALYZE

```json
{arguments_json}
```

## CHAINS FOR CONTEXT

```json
{chains_json}
```

## OUTPUT FORMAT

```json
{{
  "vulnerabilities": [
    {{
      "vulnerability_id": "V-UP1",
      "vulnerability_type": "unstated_premise",
      "argument_id": "A1-3",
      "chain_id": "Chain2",
      "location_description": "where in the argument",
      "unstated_premise": "The hidden assumption",
      "why_required": "Why the argument needs this assumption",
      "how_challengeable": "How this could be questioned",
      "severity": "critical|major|minor",
      "potential_counterargument": "What an opponent could say"
    }}
  ]
}}
```

## TARGET: 15-25 VULNERABILITIES

Previous analysis found only 5. With focused attention on hidden assumptions, find 15-25.

Return your analysis as valid JSON.""",
        "curation_prompt": "Evaluate and refine the unstated premises analysis, ensuring each hidden assumption is genuinely required and challengeable.",
        "canonical_schema": {
            "type": "object",
            "properties": {
                "vulnerabilities": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "vulnerability_id": {"type": "string"},
                            "vulnerability_type": {"type": "string"},
                            "argument_id": {"type": "string"},
                            "unstated_premise": {"type": "string"},
                            "severity": {"type": "string"}
                        }
                    }
                }
            }
        },
        "extraction_focus": ["hidden_assumptions", "required_premises", "challengeable_claims"]
    },
    {
        "engine_key": "concept_vulnerability_inferential_gaps",
        "engine_name": "Concept Vulnerability: Inferential Gaps",
        "description": "Finds places where the conclusion doesn't follow from the premises",
        "category": "concept_analysis",
        "kind": "diagnostic",
        "reasoning_domain": "logical vulnerabilities",
        "researcher_question": "Where does the reasoning skip steps or make logical leaps?",
        "extraction_prompt": """You are conducting INFERENTIAL GAPS vulnerability analysis.

## YOUR TASK

Find arguments about "{concept}" where CONCLUSIONS DON'T FOLLOW from premises.

## WHAT TO LOOK FOR

An inferential gap is where:
- The conclusion DOESN'T NECESSARILY follow
- Steps are SKIPPED in the reasoning
- The connection is ASSERTED rather than demonstrated

Types of gaps:
- Non sequiturs (conclusion unrelated to premises)
- Hasty generalizations (too few cases)
- Missing causal links (how does A cause B?)

## ARGUMENTS TO ANALYZE

```json
{arguments_json}
```

## CHAINS FOR CONTEXT

```json
{chains_json}
```

## OUTPUT FORMAT

```json
{{
  "vulnerabilities": [
    {{
      "vulnerability_id": "V-IG1",
      "vulnerability_type": "inferential_gap",
      "argument_id": "A1-5",
      "chain_id": "Chain3",
      "premise_quoted": "The premise(s)",
      "conclusion_quoted": "The conclusion",
      "gap_description": "What's missing in the reasoning",
      "gap_type": "non_sequitur|hasty_generalization|missing_causal_link|scope_shift|level_confusion",
      "severity": "critical|major|minor",
      "what_would_bridge_gap": "What additional evidence/reasoning would help"
    }}
  ]
}}
```

## TARGET: 15-25 VULNERABILITIES

Return your analysis as valid JSON.""",
        "curation_prompt": "Evaluate the inferential gaps, ensuring each represents a genuine logical leap rather than stylistic compression.",
        "canonical_schema": {
            "type": "object",
            "properties": {
                "vulnerabilities": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "vulnerability_id": {"type": "string"},
                            "vulnerability_type": {"type": "string"},
                            "gap_description": {"type": "string"},
                            "severity": {"type": "string"}
                        }
                    }
                }
            }
        },
        "extraction_focus": ["logical_leaps", "missing_steps", "non_sequiturs"]
    },
    {
        "engine_key": "concept_vulnerability_equivocations",
        "engine_name": "Concept Vulnerability: Equivocations",
        "description": "Finds terms that shift meaning within or across arguments",
        "category": "concept_analysis",
        "kind": "diagnostic",
        "reasoning_domain": "logical vulnerabilities",
        "researcher_question": "Where do key terms shift meaning in ways that undermine the argument?",
        "extraction_prompt": """You are conducting EQUIVOCATION vulnerability analysis.

## YOUR TASK

Find arguments about "{concept}" where TERMS SHIFT MEANING.

## WHAT TO LOOK FOR

An equivocation is where:
- The SAME TERM is used with DIFFERENT MEANINGS
- The argument RELIES on this ambiguity
- If meanings were CLARIFIED, the argument would weaken

Watch especially for:
- "{concept}" itself shifting meaning
- "Freedom", "democracy", "natural" type words
- Technical terms used loosely

## ARGUMENTS TO ANALYZE

```json
{arguments_json}
```

## CHAINS FOR CONTEXT

```json
{chains_json}
```

## OUTPUT FORMAT

```json
{{
  "vulnerabilities": [
    {{
      "vulnerability_id": "V-EQ1",
      "vulnerability_type": "equivocation",
      "argument_id": "A2-1",
      "chain_id": "Chain1",
      "term_at_issue": "the word/phrase",
      "meaning_1": "First sense",
      "meaning_1_location": "where it's used this way",
      "meaning_2": "Second sense",
      "meaning_2_location": "where it's used this way",
      "how_argument_exploits_ambiguity": "Why this matters",
      "severity": "critical|major|minor",
      "suggested_disambiguation": "How to clarify"
    }}
  ]
}}
```

## TARGET: 10-20 VULNERABILITIES

Return your analysis as valid JSON.""",
        "curation_prompt": "Evaluate equivocations, distinguishing genuine meaning-shifts from reasonable contextual variation.",
        "canonical_schema": {
            "type": "object",
            "properties": {
                "vulnerabilities": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "vulnerability_id": {"type": "string"},
                            "vulnerability_type": {"type": "string"},
                            "term_at_issue": {"type": "string"},
                            "severity": {"type": "string"}
                        }
                    }
                }
            }
        },
        "extraction_focus": ["meaning_shifts", "ambiguous_terms", "semantic_slippage"]
    },
    {
        "engine_key": "concept_vulnerability_question_begging",
        "engine_name": "Concept Vulnerability: Question Begging",
        "description": "Finds arguments that assume what they're trying to prove",
        "category": "concept_analysis",
        "kind": "diagnostic",
        "reasoning_domain": "logical vulnerabilities",
        "researcher_question": "Where does the argument assume what it's trying to prove?",
        "extraction_prompt": """You are conducting QUESTION-BEGGING vulnerability analysis.

## YOUR TASK

Find arguments about "{concept}" that ASSUME WHAT THEY'RE TRYING TO PROVE.

## WHAT TO LOOK FOR

Question-begging (circular reasoning) is where:
- The CONCLUSION is hidden in a PREMISE
- The argument PRESUPPOSES what it should demonstrate
- Accepting the premise REQUIRES already accepting the conclusion

Forms include:
- Explicit circularity (A because A)
- Hidden circularity (A because B, where B assumes A)
- Definition-based circularity (defining terms to make argument trivially true)

## ARGUMENTS TO ANALYZE

```json
{arguments_json}
```

## CHAINS FOR CONTEXT

```json
{chains_json}
```

## OUTPUT FORMAT

```json
{{
  "vulnerabilities": [
    {{
      "vulnerability_id": "V-QB1",
      "vulnerability_type": "question_begging",
      "argument_id": "A1-8",
      "chain_id": "Chain4",
      "conclusion_claimed": "What the argument claims to prove",
      "premise_that_assumes_it": "The premise that already assumes this",
      "circularity_explanation": "How they're the same claim",
      "circularity_type": "explicit|hidden|definitional",
      "severity": "critical|major|minor",
      "how_to_break_circle": "What independent evidence would help"
    }}
  ]
}}
```

## TARGET: 10-15 VULNERABILITIES

Return your analysis as valid JSON.""",
        "curation_prompt": "Evaluate question-begging claims, distinguishing genuine circularity from legitimate premises.",
        "canonical_schema": {
            "type": "object",
            "properties": {
                "vulnerabilities": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "vulnerability_id": {"type": "string"},
                            "vulnerability_type": {"type": "string"},
                            "circularity_explanation": {"type": "string"},
                            "severity": {"type": "string"}
                        }
                    }
                }
            }
        },
        "extraction_focus": ["circular_reasoning", "presuppositions", "definitional_tricks"]
    },
    {
        "engine_key": "concept_vulnerability_false_dichotomies",
        "engine_name": "Concept Vulnerability: False Dichotomies",
        "description": "Finds arguments that present only two options when more exist",
        "category": "concept_analysis",
        "kind": "diagnostic",
        "reasoning_domain": "logical vulnerabilities",
        "researcher_question": "Where does the argument artificially limit options?",
        "extraction_prompt": """You are conducting FALSE DICHOTOMY vulnerability analysis.

## YOUR TASK

Find arguments about "{concept}" that present FALSE EITHER/OR choices.

## WHAT TO LOOK FOR

A false dichotomy is where:
- Only TWO OPTIONS are presented
- But MORE OPTIONS actually exist
- The argument DEPENDS on the limited framing

Common forms:
- "Either X or Y" (ignoring Z)
- "If not capitalism, then what?"
- "You're either with us or against us"

## ARGUMENTS TO ANALYZE

```json
{arguments_json}
```

## CHAINS FOR CONTEXT

```json
{chains_json}
```

## OUTPUT FORMAT

```json
{{
  "vulnerabilities": [
    {{
      "vulnerability_id": "V-FD1",
      "vulnerability_type": "false_dichotomy",
      "argument_id": "A2-4",
      "chain_id": "Chain2",
      "dichotomy_presented": "Either X or Y",
      "option_1": "First option presented",
      "option_2": "Second option presented",
      "missing_options": ["Option 3", "Option 4"],
      "why_dichotomy_is_false": "Explanation",
      "severity": "critical|major|minor",
      "how_argument_depends_on_dichotomy": "Why the limited framing matters"
    }}
  ]
}}
```

## TARGET: 10-15 VULNERABILITIES

Return your analysis as valid JSON.""",
        "curation_prompt": "Evaluate false dichotomies, ensuring the missing options are genuinely viable alternatives.",
        "canonical_schema": {
            "type": "object",
            "properties": {
                "vulnerabilities": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "vulnerability_id": {"type": "string"},
                            "vulnerability_type": {"type": "string"},
                            "dichotomy_presented": {"type": "string"},
                            "missing_options": {"type": "array"},
                            "severity": {"type": "string"}
                        }
                    }
                }
            }
        },
        "extraction_focus": ["either_or_framing", "excluded_options", "binary_thinking"]
    }
]

def main():
    ENGINES_DIR.mkdir(parents=True, exist_ok=True)

    for engine in VULNERABILITY_ENGINES:
        engine["version"] = 1
        engine["paradigm_keys"] = []

        filepath = ENGINES_DIR / f"{engine['engine_key']}.json"
        with open(filepath, 'w') as f:
            json.dump(engine, f, indent=2)
        print(f"Created: {filepath.name}")

    print(f"\nCreated {len(VULNERABILITY_ENGINES)} vulnerability engines")

if __name__ == "__main__":
    main()
